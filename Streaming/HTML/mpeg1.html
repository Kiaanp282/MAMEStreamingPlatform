<!--
license:BSD-3-Clause
copyright-holders:Michele Maione
============================================================

	mame.html - MAME Game Streaming Server (aka DinoServer ðŸ¦•ðŸ§¡ðŸ¦–)

============================================================
-->
<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<meta name="date" content="2021-03-30" scheme="YYYY-MM-DD">
	<meta name="author" content="Maione Michele">
	<meta name="description" content="MAME Game Streaming Server (aka DinoServer ðŸ¦•ðŸ§¡ðŸ¦–)">

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>MAME Game Streaming Server (aka DinoServer ðŸ¦•ðŸ§¡ðŸ¦–)</title>

	<style>
		body {
			overflow: hidden;
			background-color: black;
		}
	</style>
</head>

<body>
	<canvas id="myCanvas">
		Your browser does not support the HTML canvas tag.
	</canvas>

	<script src="jsmpeg.js"></script>
	<script src="gamecontroller.min.js"></script>
	<script src="keypress-2.1.5.min.js"></script>

	<script>
		const uri = "ws://192.168.1.8:8888";

		let listener;

		let myCanvas;
		let player;
		let vw, vh, cw, ch, tw, th;

		function reportWindowSize()
		{
			cw = window.innerWidth;
			ch = window.innerHeight;

			if (cw / ch < vw / vh)
			{
				tw = cw;
				th = cw * vh / vw;
			}
			else
			{
				tw = ch * vw / vh;
				th = ch;
			}

			myCanvas.style.width = tw + 'px';
			myCanvas.style.height = th + 'px';
		}

		function InputSend(g, t)
		{
			player.source.socket.send('key:' + g + ':' + t);
		}

		function InitKeyboard()
		{
			const keyboard = 9999;
			listener = new window.keypress.Listener();

			listener.simple_combo("1", function () { InputSend(keyboard, 'SELECT'); });
			listener.simple_combo("2", function () { InputSend(keyboard, 'START'); });

			listener.simple_combo("left", function () { InputSend(keyboard, 'LEFT'); });
			listener.simple_combo("right", function () { InputSend(keyboard, 'RIGHT'); });
			listener.simple_combo("up", function () { InputSend(keyboard, 'UP'); });
			listener.simple_combo("down", function () { InputSend(keyboard, 'DOWN'); });

			listener.simple_combo("w", function () { InputSend(keyboard, 'X'); });
			listener.simple_combo("e", function () { InputSend(keyboard, 'Y'); });
			listener.simple_combo("s", function () { InputSend(keyboard, 'A'); });
			listener.simple_combo("d", function () { InputSend(keyboard, 'B'); });

			listener.simple_combo("q", function () { InputSend(keyboard, 'L1'); });
			listener.simple_combo("a", function () { InputSend(keyboard, 'L2'); });
			listener.simple_combo("r", function () { InputSend(keyboard, 'R1'); });
			listener.simple_combo("f", function () { InputSend(keyboard, 'R2'); });
		}

		function InitGamepad()
		{
			gameControl.on('connect', gamepad =>
			{
				console.log('A new gamepad was connected!');

				gamepad.on('button8', () => { InputSend(gamepad.id, 'SELECT') });
				gamepad.on('button9', () => { InputSend(gamepad.id, 'START') });

				gamepad.on('button12', () => { InputSend(gamepad.id, 'UP') });
				gamepad.on('button13', () => { InputSend(gamepad.id, 'DOWN') });
				gamepad.on('button15', () => { InputSend(gamepad.id, 'RIGHT') });
				gamepad.on('button14', () => { InputSend(gamepad.id, 'LEFT') });
				gamepad.on('up', () => { InputSend(gamepad.id, 'UP') });
				gamepad.on('down', () => { InputSend(gamepad.id, 'DOWN') });
				gamepad.on('right', () => { InputSend(gamepad.id, 'RIGHT') });
				gamepad.on('left', () => { InputSend(gamepad.id, 'LEFT') });

				gamepad.on('button2', () => { InputSend(gamepad.id, 'X') });
				gamepad.on('button3', () => { InputSend(gamepad.id, 'Y') });
				gamepad.on('button0', () => { InputSend(gamepad.id, 'A') });
				gamepad.on('button1', () => { InputSend(gamepad.id, 'B') });

				gamepad.on('button4', () => { InputSend(gamepad.id, 'L1') });
				gamepad.on('button6', () => { InputSend(gamepad.id, 'L2') });
				gamepad.on('button5', () => { InputSend(gamepad.id, 'R1') });
				gamepad.on('button7', () => { InputSend(gamepad.id, 'R2') });
			});

			gameControl.on('disconnect', gamepad =>
			{
				console.log('A gamepad was disconnected!');
			});
		}

		function Start()
		{
			document.onclick = null;

			player = new JSMpeg.Player(uri, {
				canvas: myCanvas,
				autoplay: true,
				loop: false,
				pauseWhenHidden: false,
				videoBufferSize: 96 * 1024, // 96 KB
				audioBufferSize: 64 * 1024, // 64 KB				
			});

			player.source.onStringMessageCallback = function (event)
			{
				let values = event.data.split(":");

				switch (values[0])
				{
					case 'size':
						vw = values[1];
						vh = values[2];

						reportWindowSize();
						break;

					case 'ping':
						player.source.socket.send('ping:' + values[1]);
						break;
				}
			};

			InitKeyboard();
			InitGamepad();
		}

		myCanvas = document.getElementById("myCanvas");
		window.onresize = reportWindowSize;
		document.onclick = Start;
	</script>

	<script src="fullscreen.js"></script>
</body>

</html>