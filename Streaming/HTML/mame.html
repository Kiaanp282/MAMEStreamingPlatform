<!--
license:BSD-3-Clause
copyright-holders:Michele Maione
============================================================

	mame.html - MAME Game Streaming Server (aka DinoServer ü¶ïüß°ü¶ñ)

============================================================
-->
<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<meta name="date" content="2021-04-08" scheme="YYYY-MM-DD">
	<meta name="author" content="Maione Michele">
	<meta name="description" content="MAME Game Streaming Server (aka DinoServer ü¶ïüß°ü¶ñ)">

	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>MAME Game Streaming Server</title>

	<link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Ubuntu Mono'>

	<style>
		body {	
			background-color: black;
			font-family: 'Ubuntu Mono';
		}

		.center {
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin: auto;
		}

		#myCanvas {
			display: none;
		}

		#instructions {
			color: white;
			width: 700px;
		}

		.game {
			cursor: pointer;
		}
	</style>
</head>

<body>
	<div id="instructions" class="center">
		<h1>MAME Game Streaming Server</h1>

		<h2>Keys:</h2>

		<table>
			<tr>
				<td>
					Restart:
				</td>
				<td>
					F5
				</td>
				<td width="20px">

				</td>
				<td>
					Move:
				</td>
				<td>
					‚Üê, ‚Üë, ‚Üí, ‚Üì
				</td>
			</tr>
			<tr>
				<td>
					Start:
				</td>
				<td>
					1
				</td>
				<td width="20px">

				</td>
				<td>
					Actions:
				</td>
				<td>
					Q, W, E, R, A, S, D, F
				</td>
			</tr>
			<tr>
				<td>
					Coin:
				</td>
				<td>
					2
				</td>
				<td width="20px">

				</td>
			</tr>
			<tr>
				<td>
					Pause:
				</td>
				<td>
					P
				</td>
			</tr>
		</table>

		<h3>click a game to play it</h3>

		<div id="games">
			<img onclick="Start('galaga');" class="game" src="roms/galaga.png">
			<img onclick="Start('jojoban');" class="game" src="roms/jojoban.png">
			<img onclick="Start('mslug3');" class="game" src="roms/mslug3.png">
			<img onclick="Start('mslug6');" class="game" src="roms/mslug6.png">
			<img onclick="Start('outrun');" class="game" src="roms/outrun.png">
			<img onclick="Start('spidman');" class="game" src="roms/spidman.png">
			<img onclick="Start('sfiii3nr1');" class="game" src="roms/sfiii3nr1.png">
			<img onclick="Start('strhoop');" class="game" src="roms/strhoop.png">
			<img onclick="Start('ssriders');" class="game" src="roms/ssriders.png">
			<img onclick="Start('suprmrio');" class="game" src="roms/suprmrio.png">
			<img onclick="Start('spang');" class="game" src="roms/spang.png">
			<img onclick="Start('tekken3');" class="game" src="roms/tekken3.png">
		</div>
	</div>


	<canvas id="myCanvas" class="center">
		Your browser does not support the HTML canvas tag.
	</canvas>

	<script src="jsmpeg.js"></script>
	<script src="gamecontroller.min.js"></script>
	<script src="keypress-2.1.5.min.js"></script>

	<script>
		//const uri = "ws://82.48.166.10:8888";
		const uri = "ws://localhost:8888";

		let listener;

		let myCanvas;
		let player;
		let vw, vh, cw, ch, tw, th;

		function reportWindowSize()
		{
			cw = window.innerWidth;
			ch = window.innerHeight;

			if (cw / ch < vw / vh)
			{
				tw = cw;
				th = cw * vh / vw;
			}
			else
			{
				tw = ch * vw / vh;
				th = ch;
			}

			myCanvas.style.width = tw + 'px';
			myCanvas.style.height = th + 'px';
		}

		function InputSend(g, t, down)
		{
			player.source.socket.send('key:' + (down == true ? 'D:' : 'U:') + g + ':' + t);
		}

		function InitKeyboard()
		{
			const keyboard = 9999;
			listener = new window.keypress.Listener();

			listener.register_many([
				{
					"keys": "p",
					"on_keydown": function () { InputSend(keyboard, 'PAUSE', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'PAUSE', false); },
				},
				{
					"keys": "1",
					"on_keydown": function () { InputSend(keyboard, 'START', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'START', false); },
				},
				{
					"keys": "2",
					"on_keydown": function () { InputSend(keyboard, 'SELECT', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'SELECT', false); },
				},

				{
					"keys": "left",
					"on_keydown": function () { InputSend(keyboard, 'LEFT', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'LEFT', false); },
				},
				{
					"keys": "right",
					"on_keydown": function () { InputSend(keyboard, 'RIGHT', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'RIGHT', false); },
				},
				{
					"keys": "up",
					"on_keydown": function () { InputSend(keyboard, 'UP', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'UP', false); },
				},
				{
					"keys": "down",
					"on_keydown": function () { InputSend(keyboard, 'DOWN', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'DOWN', false); },
				},

				{
					"keys": "w",
					"on_keydown": function () { InputSend(keyboard, 'X', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'X', false); },
				},
				{
					"keys": "e",
					"on_keydown": function () { InputSend(keyboard, 'Y', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'Y', false); },
				},
				{
					"keys": "s",
					"on_keydown": function () { InputSend(keyboard, 'A', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'A', false); },
				},
				{
					"keys": "d",
					"on_keydown": function () { InputSend(keyboard, 'B', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'B', false); },
				},

				{
					"keys": "q",
					"on_keydown": function () { InputSend(keyboard, 'L1', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'L1', false); },
				},
				{
					"keys": "a",
					"on_keydown": function () { InputSend(keyboard, 'L2', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'L2', false); },
				},
				{
					"keys": "r",
					"on_keydown": function () { InputSend(keyboard, 'R1', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'R1', false); },
				},
				{
					"keys": "f",
					"on_keydown": function () { InputSend(keyboard, 'R2', true); },
					"on_keyup": function (e) { InputSend(keyboard, 'R2', false); },
				},
			]);
		}

		function InitGamepad()
		{
			/*
			gameControl.on('connect', gamepad =>
			{
				console.log('A new gamepad was connected!');

				gamepad.on('button8', () => { InputSend(gamepad.id, 'SELECT') });
				gamepad.on('button9', () => { InputSend(gamepad.id, 'START') });

				gamepad.on('button12', () => { InputSend(gamepad.id, 'UP') });
				gamepad.on('button13', () => { InputSend(gamepad.id, 'DOWN') });
				gamepad.on('button15', () => { InputSend(gamepad.id, 'RIGHT') });
				gamepad.on('button14', () => { InputSend(gamepad.id, 'LEFT') });
				gamepad.on('up', () => { InputSend(gamepad.id, 'UP') });
				gamepad.on('down', () => { InputSend(gamepad.id, 'DOWN') });
				gamepad.on('right', () => { InputSend(gamepad.id, 'RIGHT') });
				gamepad.on('left', () => { InputSend(gamepad.id, 'LEFT') });

				gamepad.on('button2', () => { InputSend(gamepad.id, 'X') });
				gamepad.on('button3', () => { InputSend(gamepad.id, 'Y') });
				gamepad.on('button0', () => { InputSend(gamepad.id, 'A') });
				gamepad.on('button1', () => { InputSend(gamepad.id, 'B') });

				gamepad.on('button4', () => { InputSend(gamepad.id, 'L1') });
				gamepad.on('button6', () => { InputSend(gamepad.id, 'L2') });
				gamepad.on('button5', () => { InputSend(gamepad.id, 'R1') });
				gamepad.on('button7', () => { InputSend(gamepad.id, 'R2') });
			});

			gameControl.on('disconnect', gamepad =>
			{
				console.log('A gamepad was disconnected!');
			});
			*/
		}

		function Start(game)
		{
			document.body.style.overflow = "hidden";
			document.getElementById("instructions").style.display = "none";
			myCanvas.style.display = "inherit";			

			player = new JSMpeg.Player(uri + '?' + game, {
				canvas: myCanvas,
				autoplay: true,
				loop: false,
				pauseWhenHidden: false,
				videoBufferSize: 96 * 1024,
				audioBufferSize: 64 * 1024,
			});

			player.source.onStringMessageCallback = function (event)
			{
				let values = event.data.split(":");

				switch (values[0])
				{
					case 'size':
						vw = values[1];
						vh = values[2];

						reportWindowSize();
						break;

					case 'ping':
						player.source.socket.send('ping:' + values[1]);
						break;
				}
			};

			InitKeyboard();
			InitGamepad();
		}

		myCanvas = document.getElementById("myCanvas");
		window.onresize = reportWindowSize;
	</script>

	<script src="fullscreen.js"></script>
</body>

</html>